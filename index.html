<!doctype html>
<html lang="en" data-color-mode="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ArcheoHub â€” Git for Archaeology (Prototype)</title>

  <!-- Primer CSS (open-source GitHub design system) -->
  <link rel="stylesheet" href="https://unpkg.com/@primer/css@^21.0.0/dist/primer.css">

  <!-- Leaflet for maps -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- noUiSlider for timeline -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.js"></script>

  <!-- Three.js for 3D stratigraphy viewer -->
  <script src="https://unpkg.com/three@0.152.2/build/three.min.js"></script>

  <style>
    /* Basic visual adjustments on top of Primer to make it feel GitHub-like */
    :root { --accent: #238636; --muted: #8b949e; }
    body { background-color: #0d1117; color: #c9d1d9; font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif; }
    header.Header { background-color:#161b22; border-bottom:1px solid #30363d; }
    .brand { font-weight:700; font-size:1.15rem; margin-right:12px; color:#f0f6fc; }
    .Header-link { color:#c9d1d9; margin-right:12px; }
    .Header-link:hover { color:#fff; }
    .form-control.input-contrast, .form-select { background:#0d1117; color:#c9d1d9; border:1px solid #30363d; }
    .Box { background:#0d1117; border:1px solid #30363d; border-radius:8px; }
    .Box-row { border-top:1px solid #30363d; padding:12px; display:flex; justify-content:space-between; align-items:center; }
    .Box-row:first-child { border-top:0; }
    .Box-title { color:#c9d1d9; padding:12px; font-size:1.05rem; }
    .Label { font-size:12px; padding:4px 8px; border-radius:6px; }
    .Label--orange { background:#6f4a2e; color:#fff; }
    .Label--blue { background:#0366d6; color:#fff; }
    .Label--green { background:#2da44e; color:#fff; }
    .btn-primary { background:var(--accent); border-color:var(--accent); color:#fff; }
    footer.footer { color:var(--muted); border-top:1px solid #30363d; padding:24px 0; }
    /* layout */
    .container-lg { max-width:1200px; margin:0 auto; padding:20px; }
    .two-col { display:grid; grid-template-columns: 1fr 360px; gap:20px; }
    @media (max-width:1000px){ .two-col { grid-template-columns: 1fr; } .panel-right { position:static; } }
    /* map */
    #map { height:520px; border-radius:8px; border:1px solid #30363d; }
    /* repo list */
    .repo-title { font-weight:700; color:#58a6ff; }
    .muted { color:var(--muted); }
    /* timeline */
    #timeline { margin-top:12px; }
    /* modal overlay */
    .overlay { position:fixed; left:0; top:0; right:0; bottom:0; background: rgba(2,6,23,0.85); display:flex; align-items:center; justify-content:center; z-index:12000; }
    .card-dark { background:#0d1117; border:1px solid #30363d; color:#c9d1d9; border-radius:10px; padding:16px; }
    /* small responsive tweaks */
    .small { font-size:13px; }
    .btn-ghost { background: transparent; border: 1px solid rgba(255,255,255,0.04); color: #c9d1d9; }
    /* tabs */
    .tabs .tab { cursor:pointer; border-radius:6px; margin-right:6px; }
    .tabs .tab.selected { background: rgba(88,166,255,0.08); }
    /* contribution list */
    .contrib-list { display:grid; gap:8px; }
    .form-compact label{display:block;margin-bottom:8px;}
    .form-compact input,.form-compact textarea,.form-compact select{width:100%;box-sizing:border-box;margin-top:4px;}
  </style>
</head>
<body>

<header class="Header d-flex flex-justify-between flex-items-center p-3">
  <div class="d-flex flex-items-center">
    <a class="brand">ArcheoHub</a>
    <div class="d-none d-md-block">
      <a class="Header-link" href="#" data-route="explore">Explore</a>
      <a class="Header-link" href="#" data-route="map">Map</a>
      <a class="Header-link" href="#" data-route="issues">Issues</a>
      <a class="Header-link" href="#" data-route="prs">Pull requests</a>
    </div>
  </div>

  <div style="flex:1; margin:0 16px;">
    <input id="global-search" type="search" class="form-control input-contrast header-search-input" placeholder="Search archaeological sites, repos, or commitsâ€¦" aria-label="Search" />
  </div>

  <div class="d-flex flex-items-center gap-2">
    <button id="theme-toggle" class="btn btn-ghost btn-sm" title="Toggle theme">ðŸŒ—</button>
    <button id="new-finding-btn" class="btn btn-primary btn-sm">+ New finding</button>

    <details class="details-reset details-overlay" style="margin-left:8px;">
      <summary id="avatar-summary" class="Header-link" aria-haspopup="menu" role="button">
        <img id="avatar-img" class="avatar avatar-user" src="https://avatars.githubusercontent.com/u/0?v=4" width="32" height="32" alt="@guest">
      </summary>
      <div class="dropdown-menu dropdown-menu-sw mt-2" style="width:260px;">
        <div class="dropdown-header">Signed in as <strong id="user-email">guest</strong></div>
        <a class="dropdown-item" href="#" data-route="profile">Your profile</a>
        <a class="dropdown-item" href="#" id="logout-btn">Sign out</a>
      </div>
    </details>
  </div>
</header>

<!-- Main container -->
<div class="container-lg">
  <!-- top banner / filters -->
  <div class="d-flex flex-justify-between mb-4">
    <div>
      <h1 class="f1 text-normal">ArcheoHub â€” Git for Archaeology</h1>
      <p class="muted small">Explore sites, commits, stratigraphy diffs, issues and pull requests. This is a prototype â€” data is local & simulated.</p>
    </div>
    <div class="d-none d-md-flex flex-items-center gap-2">
      <select id="filter-type" class="form-select form-select-sm">
        <option value="">All commit types</option>
        <option>Discovery</option>
        <option>Analysis</option>
        <option>Theory</option>
        <option>Preservation</option>
        <option>Maintenance</option>
      </select>
      <button id="open-explore" class="btn btn-ghost btn-sm">Explore</button>
    </div>
  </div>

  <!-- SPA render target -->
  <div id="app-root"></div>
</div>

<!-- New Finding Modal -->
<div id="new-finding-modal" class="overlay" hidden>
  <div class="card-dark" style="width:720px; max-width:95%;">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h3 style="margin:0">New Archaeological Finding</h3>
      <button id="close-new-finding" class="btn btn-ghost btn-sm">Close</button>
    </div>
    <!-- NOTE: form updated to include submitterEmail for Formspree -->
    <form id="new-finding-form" class="form-compact">
      <div class="d-flex gap-2">
        <input name="repo" placeholder="Repository path (e.g. europe/greece/crete/knossos)" class="form-control form-control-sm" required />
        <select name="type" class="form-select form-select-sm" style="width:180px;">
          <option>Discovery</option>
          <option>Analysis</option>
          <option>Theory</option>
          <option>Preservation</option>
          <option>Maintenance</option>
        </select>
      </div>
      <div class="mt-2"><input name="title" placeholder="Title" class="form-control form-control-sm" required /></div>

      <!-- Added optional submitter email for Formspree reply-to -->
      <div class="mt-2">
        <input name="submitterEmail" placeholder="Your email (optional)" class="form-control form-control-sm" />
      </div>

      <div class="mt-2"><textarea name="desc" placeholder="Description" class="form-control form-control-sm" rows="5"></textarea></div>
      <div class="mt-2 d-flex justify-content-end gap-2">
        <button type="button" id="submit-finding" class="btn btn-primary">Submit</button>
      </div>
    </form>

    <!-- Direct Formspree form as backup (submits to Formspree and opens result in new tab) -->
    <hr style="margin:12px 0; border-color:#30363d;">
    <div style="margin-top:8px;">
      <div style="font-weight:700; margin-bottom:8px;">Also send a message (direct Formspree form)</div>
      <form action="https://formspree.io/f/xdakdvqo" method="POST" class="form-compact" target="_blank">
        <label>
          Your email:
          <input type="email" name="email" class="form-control form-control-sm" />
        </label>
        <label>
          Your message:
          <textarea name="message" class="form-control form-control-sm" rows="4"></textarea>
        </label>
        <input type="hidden" name="_subject" value="ArcheoHub â€” New finding (direct form)" />
        <div style="margin-top:8px; text-align:right;">
          <button type="submit" class="btn btn-ghost">Send via Formspree</button>
        </div>
      </form>
    </div>

  </div>
</div>

<!-- Login / Signup Modal -->
<div id="auth-modal" class="overlay" hidden>
  <div class="card-dark" style="width:420px; max-width:95%;">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h3 style="margin:0" id="auth-title">Sign in</h3>
      <button id="auth-close" class="btn btn-ghost btn-sm">Close</button>
    </div>
    <div>
      <div class="mb-2 small muted" id="auth-note">Use a Gmail address for demo sign-in (local only).</div>
      <input id="auth-email" class="form-control form-control-sm mb-2" placeholder="you@gmail.com" />
      <input id="auth-name" class="form-control form-control-sm mb-2" placeholder="Display name (optional)" />
      <div class="d-flex justify-content-end gap-2">
        <button id="auth-submit" class="btn btn-primary">Sign in</button>
      </div>
    </div>
  </div>
</div>

<!-- Simple toast -->
<div id="toast" style="position:fixed; right:18px; bottom:18px; z-index:14000;"></div>

<!-- Footer -->
<footer class="footer mt-5">
  <div class="container-lg text-center">
    <p class="mb-0">Â© 2026 ArcheoHub â€” Prototype. Contact: <a href="mailto:shyn.aityk@gmail.com">shyn.aityk@gmail.com</a></p>
  </div>
</footer>

<script>
/* ----------------------------------------------------------------------------
   Full SPA code with Formspree integration added.
   I preserved your full original application logic (map, repos, profile,
   PRs/issues, diff, 3D viewer, CSV export) and inserted Formspree email send.

   Notes:
   - Formspree endpoint: https://formspree.io/f/xdakdvqo (you confirmed ownership)
   - New Finding form now accepts an optional email (submitterEmail) used as _replyto
   - On submit the app saves data locally (as before) and posts JSON to Formspree
   ---------------------------------------------------------------------------- */

/* Helpers */
function uid(prefix='id'){ return prefix + '-' + Math.random().toString(36).slice(2,9); }
function now(){ return new Date().toISOString(); }
function saveLS(key,value){ try { localStorage.setItem(key, JSON.stringify(value)); } catch(e){ console.warn('saveLS error', e); } }
function loadLS(key, fallback){ try{ const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; }catch(e){ return fallback; } }
function toast(msg, ms=2500){ const t=document.createElement('div'); t.className='Box p-2 mb-2'; t.style.background='#0b1220'; t.textContent=msg; document.getElementById('toast').appendChild(t); setTimeout(()=> t.remove(), ms); }

/* Attach event if element exists; accepts element or selector */
function safeOn(target, event, handler){
  if(!target) return;
  let el = null;
  if(typeof target === 'string') el = document.querySelector(target);
  else el = target;
  if(el && typeof el.addEventListener === 'function') el.addEventListener(event, handler);
}

/* Basic HTML escape */
function escapeHTML(s){
  if (s === null || s === undefined) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

/* ----------------------------------------------------------------------------
   Formspree helper: sends JSON to your form endpoint.
   ---------------------------------------------------------------------------- */
const FORMSPREE_ENDPOINT = 'https://formspree.io/f/xdakdvqo';

async function sendFindingToFormspree(payload){
  try {
    const res = await fetch(FORMSPREE_ENDPOINT, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify({
        email: payload.email || '',
        repo: payload.repoPath,
        type: payload.type,
        title: payload.title,
        message: payload.desc,
        author: payload.author,
        time: payload.time,
        _subject: `ArcheoHub â€” New finding: ${payload.title}`,
        _replyto: payload.email || ''
      })
    });
    if(res.ok) return { ok:true };
    const text = await res.text().catch(()=>null);
    console.warn('Formspree response not ok', res.status, text);
    return { ok:false, status:res.status, text };
  } catch(err){
    console.error('sendFindingToFormspree error', err);
    return { ok:false, error:String(err) };
  }
}

/* ----------------------------------------------------------------------------
   Application State (unchanged)
   ---------------------------------------------------------------------------- */
const App = {
  theme: localStorage.getItem('theme') || 'dark',
  user: loadLS('archeo_user', null),    // { email, displayName, bio, website }
  repos: loadLS('archeo_repos', null),
  issues: loadLS('archeo_issues', null),
  prs: loadLS('archeo_prs', null),
  page: 'explore',
  currentRepoId: null,
  filter: { type: '', search: '', yearRange: [-3000, 2020] }
};

document.documentElement.setAttribute('data-color-mode', App.theme);

/* ----------------------------------------------------------------------------
   Data seeding (unchanged except owners default to "community")
   ---------------------------------------------------------------------------- */
if(!App.repos){
  App.repos = [];
  const BASE = [
    ["Giza Plateau","Egypt",29.9792,31.1342],
    ["Pompeii","Italy",40.7460,14.4989],
    ["Stonehenge","UK",51.1789,-1.8262],
    ["Machu Picchu","Peru",-13.1631,-72.5450],
    ["Angkor Wat","Cambodia",13.4125,103.8667],
    ["Teotihuacan","Mexico",19.6925,-98.8438],
    ["GÃ¶bekli Tepe","Turkey",37.2231,38.9226],
    ["Petra","Jordan",30.3285,35.4444],
    ["Tikal","Guatemala",17.2220,-89.6237],
    ["Derinkuyu","Turkey",38.3745,34.7364]
  ];

  const COMMIT_TYPES = ["Discovery","Analysis","Theory","Preservation","Maintenance"];
  const authors = ["Dr. A. Silva","Prof. M. Chen","L. Ortega","S. Ibrahim","Y. Petrov","N. Okeke","E. Rossi","H. Nakamura"];
  const commitMsgs = ["Trench logged","Portable XRF sample","Radiocarbon sent to lab","Soil profile documented","Consolidation treatment","Geophysical survey added","Artifact cataloged","Initial survey notes"];

  let rid = 1;
  BASE.forEach((b) => {
    for(let i=0;i<20;i++){
      const lat = b[2] + (Math.random()-0.5)*0.4;
      const lon = b[3] + (Math.random()-0.5)*0.4;
      const commits = [];
      const commitCount = Math.floor(Math.random()*14)+4;
      for(let c=0;c<commitCount;c++){
        const year = Math.floor(-3000 + Math.pow(Math.random(),0.8)*(2020+3000));
        const L = Math.floor(Math.random()*5)+1;
        const layers = [];
        for(let li=0; li<L; li++){
          layers.push({ id: uid('layer'), name:`Layer ${li+1}`, thickness: Math.round(Math.random()*50+5), color: ['#c2a97f','#8fbf9f','#c27ba0','#7fa7d9'][Math.floor(Math.random()*4)], notes: "Sample description" });
        }
        commits.push({ id: `${rid}-c${c}`, author: authors[Math.floor(Math.random()*authors.length)], year, type: COMMIT_TYPES[Math.floor(Math.random()*COMMIT_TYPES.length)], message: commitMsgs[Math.floor(Math.random()*commitMsgs.length)], layers });
      }
      commits.sort((a,b)=>a.year-b.year);
      App.repos.push({
        id: String(rid),
        name: `${b[0]} Sector ${i+1}`,
        site: b[0],
        country: b[1],
        lat, lon,
        image: `https://images.unsplash.com/photo-1526772662000-3f88f10405ff?q=80&w=1400&auto=format&fit=crop&s=${Math.floor(Math.random()*100000)}`,
        commits,
        branches: [],
        stars: Math.floor(Math.random()*5000),
        forks: Math.floor(Math.random()*600),
        owner: 'community'
      });
      rid++;
    }
  });

  const extras = [
    ["Lascaux","France",45.053,1.167],
    ["Pavlopetri","Greece",36.7,22.45]
  ];
  extras.forEach((b)=>{
    const commits=[];
    for(let c=0;c<8;c++){
      commits.push({ id: uid('ex'), author: "A. Researcher", year: Math.floor(-3000 + Math.random()*5000), type: "Discovery", message: "Sample commit", layers:[{ id: uid('l'), name:"Topsoil", thickness:20, color:'#7fa7d9', notes:'' }] });
    }
    App.repos.push({ id: String(rid++), name:b[0], site:b[0], country:b[1]||'Unknown', lat:b[2], lon:b[3], image:'https://images.unsplash.com/photo-1526772662000-3f88f10405ff?q=80&w=1400', commits, branches:[], stars: Math.floor(Math.random()*3000), forks: Math.floor(Math.random()*200), owner: 'community' });
  });

  saveLS('archeo_repos', App.repos);
}

/* Issues & PRs basic seed */
if(!App.issues){
  App.issues = [
    { id: uid('iss'), title: "Artifact numbering mismatch", repoId: App.repos[0].id, status: "todo", author: "Dr. A. Silva", created: now(), comments: [] },
    { id: uid('iss'), title: "Layer depth discrepancy", repoId: App.repos[1].id, status: "inprogress", author: "E. Rossi", created: now(), comments: [] }
  ];
  saveLS('archeo_issues', App.issues);
}
if(!App.prs){
  App.prs = [
    { id: uid('pr'), title: "Add geophysical survey results", repoId: App.repos[2].id, author: "L. Ortega", created: now(), status: "open", description: "Adding XRF layer results." }
  ];
  saveLS('archeo_prs', App.prs);
}

/* ----------------------------------------------------------------------------
   Routing & Navigation
   ---------------------------------------------------------------------------- */
function navigate(page, opts={}){
  App.page = page;
  if(opts.repoId) App.currentRepoId = opts.repoId;
  try { history.pushState({page, opts}, '', `#${page}${opts.repoId?'-'+opts.repoId:''}`); } catch(e){}
  render();
}
window.addEventListener('popstate', ()=> {
  const h = window.location.hash.slice(1);
  if(!h) { App.page='explore'; App.currentRepoId=null; } else {
    const parts = h.split('-');
    App.page = parts[0] || 'explore';
    App.currentRepoId = parts[1] || null;
  }
  render();
});

/* ----------------------------------------------------------------------------
   Auth & Profile helpers
   ---------------------------------------------------------------------------- */
function setUser(user){
  App.user = user;
  saveLS('archeo_user', user);
  updateHeaderAuth();
}
function signOut(){
  App.user = null;
  localStorage.removeItem('archeo_user');
  updateHeaderAuth();
  toast('Signed out');
}
function updateHeaderAuth(){
  const el = document.getElementById('avatar-img');
  const emailEl = document.getElementById('user-email');
  if(App.user){
    const initials = (App.user.displayName||App.user.email).split(' ').map(s=>s[0]).slice(0,2).join('').toUpperCase();
    el.src = `https://avatars.dicebear.com/api/initials/${encodeURIComponent(initials)}.svg`;
    emailEl.textContent = App.user.email;
  } else {
    el.src = 'https://avatars.githubusercontent.com/u/0?v=4';
    emailEl.textContent = 'guest';
  }
}

/* Centralized delete helpers */
function deleteIssue(issueId){
  const idx = App.issues.findIndex(i => i.id === issueId);
  if(idx === -1) return false;
  if(!confirm('Delete this issue? This cannot be undone.')) return false;
  App.issues.splice(idx, 1);
  saveLS('archeo_issues', App.issues);
  toast('Issue deleted');
  render();
  return true;
}
function deletePR(prId){
  const idx = App.prs.findIndex(p => p.id === prId);
  if(idx === -1) return false;
  if(!confirm('Delete this pull request? This cannot be undone.')) return false;
  App.prs.splice(idx, 1);
  saveLS('archeo_prs', App.prs);
  toast('Pull request deleted');
  render();
  return true;
}

/* Auth modal wiring */
safeOn('#auth-submit', 'click', ()=>{
  const email = (document.getElementById('auth-email') || {}).value || '';
  const name = (document.getElementById('auth-name') || {}).value || '';
  if(!email || !email.endsWith('@gmail.com')) { alert('Please provide a valid @gmail.com address (demo).'); return; }
  const user = Object.assign({ bio:'', website:'' }, { email, displayName: name || email.split('@')[0] });
  setUser(user);
  const authModal = document.getElementById('auth-modal');
  if(authModal) authModal.hidden = true;
  toast('Signed in as ' + user.email);
});
safeOn('#auth-close', 'click', ()=> { const m = document.getElementById('auth-modal'); if(m) m.hidden = true; });
safeOn('#logout-btn', 'click', ()=> signOut());

/* Avatar click: if signed-in navigate to profile; if not, show auth modal */
document.querySelectorAll('details > summary').forEach(s=>{
  s.addEventListener('click', (e)=>{
    const details = e.currentTarget.parentElement;
    if(!App.user && details.classList.contains('details-overlay')){
      e.preventDefault();
      const m = document.getElementById('auth-modal'); if(m) m.hidden = false;
    } else {
      e.preventDefault();
      if(details) details.removeAttribute('open');
      navigate('profile');
    }
  });
});

/* Theme toggle and new finding wiring */
safeOn('#theme-toggle', 'click', ()=>{
  App.theme = App.theme === 'dark' ? 'light' : 'dark';
  document.documentElement.setAttribute('data-color-mode', App.theme);
  localStorage.setItem('theme', App.theme);
});
safeOn('#new-finding-btn','click', ()=> {
  const m = document.getElementById('new-finding-modal'); if(m) m.hidden = false;
});
safeOn('#close-new-finding','click', ()=> { const m = document.getElementById('new-finding-modal'); if(m) m.hidden = true; });

/* New finding: record owner when creating a repo AND send to Formspree */
safeOn('#submit-finding','click', async ()=>{
  const form = document.getElementById('new-finding-form');
  if(!form) return;
  const repoPath = (form.repo || {}).value ? form.repo.value.trim() : '';
  const title = form.title.value.trim();
  const type = form.type.value;
  const desc = form.desc.value.trim();
  const submitterEmail = form.submitterEmail ? form.submitterEmail.value.trim() : (App.user ? App.user.email : '');

  if(!repoPath || !title){ alert('Please provide a repository path and title'); return; }
  let repo = App.repos.find(r=> r.name.toLowerCase() === repoPath.toLowerCase());
  if(!repo){
    repo = {
      id: String(App.repos.length+1),
      name: repoPath,
      site: repoPath.split('/')[0] || 'unknown',
      country: 'Unknown',
      lat: 0, lon: 0,
      image: 'https://images.unsplash.com/photo-1526772662000-3f88f10405ff?q=80&w=1400',
      commits: [],
      branches: [],
      stars: 0,
      forks: 0,
      owner: App.user ? App.user.displayName : 'guest'
    };
    App.repos.unshift(repo);
  }
  const commit = { id: uid('c'), author: App.user ? App.user.displayName : 'guest', year: new Date().getFullYear(), type, message: title, layers:[{id:uid('L'), name:'new layer', thickness:10, color:'#c2a97f', notes: desc}] };
  repo.commits.push(commit);
  saveLS('archeo_repos', App.repos);

  // Build email payload
  const payload = {
    repoPath,
    title,
    type,
    desc,
    author: App.user ? App.user.displayName : 'guest',
    email: submitterEmail,
    time: new Date().toISOString()
  };

  // UI: disable submit button while sending
  const submitBtn = document.getElementById('submit-finding');
  if(submitBtn) { submitBtn.disabled = true; submitBtn.textContent = 'Sendingâ€¦'; }

  // send to Formspree
  const result = await sendFindingToFormspree(payload);

  // restore button
  if(submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'Submit'; }

  if(result.ok) {
    toast('Finding submitted and emailed');
  } else {
    toast('Finding submitted (email failed - check console)');
  }

  const m = document.getElementById('new-finding-modal'); if(m) m.hidden = true;
  render();
});

/* ----------------------------------------------------------------------------
   Renderers (full implementations preserved)
   - render, renderExplore, renderMap, renderRepo, loadRepoTab, renderIssuesBoard,
     renderPRList, mergePR, openDiffChooser, showDiffResults, open3DViewer,
     renderProfile, exportContributionsCSV
   The original full implementations are present below (kept intact).
   ---------------------------------------------------------------------------- */

function repoCardHTML(repo){
  const latest = repo.commits[repo.commits.length-1];
  return `
    <div class="Box-row">
      <div style="flex:1">
        <div class="repo-title"><a href="#" data-route="repo" data-repo="${repo.id}">${escapeHTML(repo.name)}</a></div>
        <div class="small muted">${escapeHTML(repo.site)} â€¢ ${escapeHTML(repo.country)}</div>
        <div class="small muted" style="margin-top:6px;">${escapeHTML(latest ? (latest.type + ' â€¢ ' + latest.year + ' â€¢ ' + latest.message) : 'No commits')}</div>
      </div>
      <div style="text-align:right;">
        <div class="small muted">â˜… ${repo.stars}</div>
        <div style="margin-top:8px;">
          <button class="btn btn-sm btn-ghost" data-action="star" data-id="${repo.id}">Star</button>
          <button class="btn btn-sm btn-primary" data-action="open" data-id="${repo.id}">Open</button>
        </div>
      </div>
    </div>
  `;
}

function render(){
  updateHeaderAuth();
  const root = document.getElementById('app-root');
  if(!root) return;
  root.innerHTML = '';

  const globalSearch = document.getElementById('global-search');
  if(globalSearch){
    globalSearch.onkeypress = (e)=>{
      if(e.key === 'Enter'){
        App.filter.search = e.target.value.trim();
        navigate('explore');
      }
    };
  }

  if(App.page === 'explore') return renderExplore(root);
  if(App.page === 'map') return renderMap(root);
  if(App.page === 'repo') return renderRepo(root, App.currentRepoId);
  if(App.page === 'profile') return renderProfile(root);
  if(App.page === 'issues') return renderIssuesBoard(root);
  if(App.page === 'prs') return renderPRList(root);

  renderExplore(root);
}

/* Explore */
function renderExplore(root){
  root.innerHTML = `
    <div class="two-col">
      <div>
        <div class="Box mb-4">
          <div class="Box-title">Explore repositories</div>
          <div id="repo-list" class="Box-body p-0"></div>
        </div>

        <div class="Box mt-4">
          <div class="Box-title">Timeline</div>
          <div class="Box-body p-3">
            <div id="timeline"></div>
            <div class="small muted mt-2">Filter commits by year range</div>
          </div>
        </div>
      </div>

      <aside class="panel-right">
        <div class="Box p-3 mb-3">
          <div style="font-weight:700">Filters</div>
          <div class="mt-2">
            <label class="small muted">Commit type</label>
            <select id="explore-filter-type" class="form-select form-select-sm mt-1">
              <option value="">All</option>
              <option>Discovery</option>
              <option>Analysis</option>
              <option>Theory</option>
              <option>Preservation</option>
              <option>Maintenance</option>
            </select>
          </div>
          <div class="mt-3">
            <label class="small muted">Search</label>
            <input id="explore-search" class="form-control form-control-sm mt-1" placeholder="site, repo, country" />
          </div>
          <div class="mt-3">
            <button id="apply-filters" class="btn btn-primary btn-sm">Apply</button>
          </div>
        </div>
        <div class="Box p-3">
          <div style="font-weight:700">Quick actions</div>
          <div class="mt-2 small muted">Demo repo operations</div>
          <div class="mt-2">
            <button id="open-map" class="btn btn-ghost btn-sm">Open Map</button>
            <button id="open-issues" class="btn btn-ghost btn-sm">Issues board</button>
          </div>
        </div>
      </aside>
    </div>
  `;
  const listEl = document.getElementById('repo-list');
  function filterRepos(){
    const [from,to] = App.filter.yearRange;
    let repos = App.repos.filter(r => {
      const timeOk = r.commits.some(c => c.year >= from && c.year <= to);
      if(!timeOk) return false;
      if(App.filter.type && !r.commits.some(c => c.type === App.filter.type)) return false;
      if(App.filter.search){
        const t = `${r.name} ${r.site} ${r.country}`.toLowerCase();
        if(!t.includes(App.filter.search.toLowerCase())) return false;
      }
      return true;
    });
    repos.sort((a,b)=> b.stars - a.stars);
    return repos;
  }
  function renderList(){
    const repos = filterRepos();
    listEl.innerHTML = repos.map(r => repoCardHTML(r)).join('');
    listEl.querySelectorAll('[data-action="open"]').forEach(btn=>{
      btn.addEventListener('click', (e)=> {
        const id = e.currentTarget.dataset.id;
        navigate('repo', { repoId: id });
      });
    });
    listEl.querySelectorAll('a[data-route="repo"]').forEach(a=>{
      a.addEventListener('click', (e)=> { e.preventDefault(); const id = e.currentTarget.getAttribute('data-repo'); navigate('repo', { repoId: id }); });
    });
    listEl.querySelectorAll('[data-action="star"]').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        const id = e.currentTarget.dataset.id;
        const repo = App.repos.find(r=>r.id===id);
        if(repo){ repo.stars += 1; saveLS('archeo_repos', App.repos); render(); toast('Starred'); }
      });
    });
  }

  const timelineEl = document.getElementById('timeline');
  timelineEl.innerHTML = '<div id="time-slider"></div>';
  const timeSliderElement = document.getElementById('time-slider');
  if (typeof noUiSlider !== 'undefined' && timeSliderElement) {
    if(!timeSliderElement._init){
      noUiSlider.create(timeSliderElement, {
        start: App.filter.yearRange,
        connect: true,
        range: { min: -3000, max: 2020 },
        step: 10,
        tooltips: [true, true],
        format: { to: v => Math.round(v), from: v => Number(v) }
      });
      timeSliderElement.noUiSlider.on('update', (v)=>{
        App.filter.yearRange = [Number(v[0]), Number(v[1])];
        renderList();
      });
      timeSliderElement._init = true;
    } else {
      timeSliderElement.noUiSlider.set(App.filter.yearRange);
    }
  } else {
    timelineEl.insertAdjacentHTML('beforeend', '<div class="muted small">Timeline requires noUiSlider (disabled).</div>');
    console.warn('noUiSlider not available â€” timeline disabled');
  }

  const typeSelect = document.getElementById('explore-filter-type');
  const searchInput = document.getElementById('explore-search');
  if(typeSelect) typeSelect.value = App.filter.type;
  if(searchInput) searchInput.value = App.filter.search;
  safeOn('#apply-filters','click', ()=>{
    App.filter.type = typeSelect ? typeSelect.value : '';
    App.filter.search = searchInput ? searchInput.value.trim() : '';
    renderList();
  });

  safeOn('#open-map','click', ()=> navigate('map'));
  safeOn('#open-issues','click', ()=> navigate('issues'));

  renderList();
}

/* Map */
function renderMap(root){
  root.innerHTML = `
    <div class="Box p-3">
      <div class="d-flex justify-content-between">
        <div><h3 class="Box-title">Map â€” Archaeological Repositories</h3></div>
        <div class="small muted">Click marker to open repo</div>
      </div>
      <div id="map" class="mt-3"></div>
    </div>
  `;
  const mapEl = document.getElementById('map');
  if(!mapEl) return;
  if(typeof L === 'undefined'){
    mapEl.innerHTML = '<div class="muted small">Leaflet not loaded â€” map unavailable.</div>';
    console.warn('Leaflet not available');
    return;
  }
  mapEl.innerHTML = '';
  const map = L.map(mapEl).setView([20, 0], 2);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);

  App.repos.forEach(repo=>{
    if(typeof repo.lat !== 'number' || typeof repo.lon !== 'number') return;
    if(repo.lat === 0 && repo.lon === 0) return;
    const marker = L.circleMarker([repo.lat, repo.lon], { radius:6, color:'#071625', fillColor:'#58a6ff', fillOpacity:0.95 }).addTo(map);
    marker.on('click', ()=> navigate('repo', { repoId: repo.id }));
    const popup = `<div style="width:220px;"><strong>${escapeHTML(repo.name)}</strong><div class="muted small">${escapeHTML(repo.site)} â€¢ ${escapeHTML(repo.country)}</div></div>`;
    marker.bindPopup(popup);
  });
}

/* Repo view (tabs, diff/3D) */
function renderRepo(root, repoId){
  const repo = App.repos.find(r=> r.id === String(repoId)) || App.repos[0];
  App.currentRepoId = repo.id;

  root.innerHTML = `
    <div class="two-col">
      <div>
        <div class="Box p-3 mb-3">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div>
              <div class="repo-title">${escapeHTML(repo.name)}</div>
              <div class="muted small">${escapeHTML(repo.site)} â€¢ ${escapeHTML(repo.country)}</div>
            </div>
            <div>
              <button id="fork-btn" class="btn btn-ghost btn-sm">Fork</button>
              <button id="star-btn" class="btn btn-primary btn-sm">Star (${repo.stars})</button>
            </div>
          </div>
        </div>

        <div class="Box mb-3">
          <div class="tabs d-flex" style="border-bottom:1px solid #30363d; padding:8px;">
            <div class="tab selected p-2" data-tab="code">Code</div>
            <div class="tab p-2" data-tab="issues">Issues</div>
            <div class="tab p-2" data-tab="prs">Pull requests</div>
            <div class="tab p-2" data-tab="timeline">Timeline</div>
          </div>
          <div id="repo-tab-content" class="p-3"></div>
        </div>
      </div>

      <aside class="panel-right">
        <div class="Box p-3 mb-3">
          <div style="font-weight:700">Repo details</div>
          <div class="muted small mt-2">Stars: ${repo.stars} â€¢ Forks: ${repo.forks}</div>
          <div class="mt-3">
            <button id="open-3d" class="btn btn-ghost btn-sm">Open latest commit 3D</button>
          </div>
        </div>
        <div class="Box p-3">
          <div style="font-weight:700">Latest commits</div>
          <div class="mt-2 small muted">${repo.commits.length} commits</div>
          <div id="recent-commits" style="margin-top:12px; max-height:220px; overflow:auto;"></div>
        </div>
      </aside>
    </div>
  `;
  const tabs = document.querySelectorAll('.tab');
  tabs.forEach(t=> t.addEventListener('click', (e)=> { tabs.forEach(x=> x.classList.remove('selected')); e.currentTarget.classList.add('selected'); const tab = e.currentTarget.getAttribute('data-tab'); loadRepoTab(tab, repo); }));
  loadRepoTab('code', repo);

  const rc = document.getElementById('recent-commits');
  if(rc) rc.innerHTML = repo.commits.slice().reverse().map(c=>`<div style="padding:8px; border-bottom:1px solid #30363d;"><div style="font-weight:700">${escapeHTML(c.message)}</div><div class="muted small">${escapeHTML(c.author)} â€¢ ${escapeHTML(c.year)} â€¢ ${escapeHTML(c.type)}</div></div>`).join('');

  safeOn('#star-btn','click', ()=>{
    repo.stars += 1;
    saveLS('archeo_repos', App.repos);
    toast('Starred ' + repo.name);
    render();
  });
  safeOn('#fork-btn','click', ()=>{
    const branch = { id: uid('branch'), name: `${App.user?App.user.displayName:'guest'}-fork-${repo.branches.length+1}`, commits: JSON.parse(JSON.stringify(repo.commits)) };
    repo.branches.push(branch);
    saveLS('archeo_repos', App.repos);
    toast('Fork created: ' + branch.name);
    renderRepo(document.getElementById('app-root'), repo.id);
  });
  safeOn('#open-3d','click', ()=> open3DViewer(repo, repo.commits[repo.commits.length-1]));
}

function loadRepoTab(tab, repo){
  const out = document.getElementById('repo-tab-content');
  if(!out) return;
  if(tab === 'code'){
    out.innerHTML = `
      <div><strong>Repository files (simulated)</strong></div>
      <div class="mt-2 small muted">Commits act as snapshots.</div>
      <div style="margin-top:12px;">
        ${repo.commits.slice().reverse().map(c=>`<div style="padding:10px; border-bottom:1px solid #30363d;"><div style="font-weight:700">${escapeHTML(c.message)}</div><div class="muted small">${escapeHTML(c.author)} â€¢ ${escapeHTML(c.year)} â€¢ <button class="btn btn-sm btn-ghost btn-diff" data-commit="${c.id}">Diff</button> <button class="btn btn-sm btn-ghost btn-3d" data-commit="${c.id}">3D</button></div></div>`).join('')}
      </div>
    `;
    out.querySelectorAll('.btn-diff').forEach(b=> b.addEventListener('click', (e)=> openDiffChooser(repo, e.currentTarget.dataset.commit)));
    out.querySelectorAll('.btn-3d').forEach(b=> b.addEventListener('click', (e)=> { const commit = repo.commits.find(x=> x.id === e.currentTarget.dataset.commit); open3DViewer(repo, commit); }));
  } else if(tab === 'issues'){
    const list = App.issues.filter(i=> i.repoId === repo.id);
    out.innerHTML = `
      <div class="d-flex justify-content-between align-items-center">
        <strong>Issues for ${escapeHTML(repo.name)}</strong>
        <button id="new-issue" class="btn btn-primary btn-sm">New issue</button>
      </div>
      <div class="mt-2">
        ${list.map(i=> `<div style="padding:10px; border-bottom:1px solid #30363d; display:flex; justify-content:space-between; align-items:center;"><div><div style="font-weight:700">${escapeHTML(i.title)}</div><div class="muted small">${escapeHTML(i.author)} â€¢ ${escapeHTML(i.status)}</div></div><div style="display:flex; gap:8px;"><button class="btn btn-sm btn-ghost btn-delete-issue" data-id="${i.id}">Delete</button></div></div>`).join('')}
      </div>
    `;
    safeOn('#new-issue','click', ()=> {
      const title = prompt('Issue title');
      if(!title) return;
      const issue = { id: uid('iss'), title, repoId: repo.id, status:'todo', author: App.user?App.user.displayName:'guest', created: now(), comments:[] };
      App.issues.push(issue);
      saveLS('archeo_issues', App.issues);
      loadRepoTab('issues', repo);
      toast('Issue created');
    });
    out.querySelectorAll('.btn-delete-issue').forEach(b=> b.addEventListener('click', (e)=> deleteIssue(e.currentTarget.dataset.id)));
  } else if(tab === 'prs'){
    const prs = App.prs.filter(p=> p.repoId === repo.id);
    out.innerHTML = `
      <div class="d-flex justify-content-between align-items-center">
        <strong>Pull Requests</strong>
        <button id="new-pr" class="btn btn-primary btn-sm">New PR</button>
      </div>
      <div class="mt-2">
        ${prs.map(p=> `<div style="padding:10px; border-bottom:1px solid #30363d; display:flex; justify-content:space-between; align-items:center;"><div><div style="font-weight:700">${escapeHTML(p.title)}</div><div class="muted small">${escapeHTML(p.author)} â€¢ ${escapeHTML(p.status)}</div></div><div style="display:flex; gap:8px;"><button class="btn btn-sm btn-ghost btn-merge" data-pr="${p.id}">Merge</button><button class="btn btn-sm btn-ghost btn-delete-pr" data-pr="${p.id}">Delete</button></div></div>`).join('')}
      </div>
    `;
    out.querySelectorAll('.btn-merge').forEach(b=> b.addEventListener('click', (e)=> { mergePR(e.currentTarget.dataset.pr); loadRepoTab('prs', repo); }));
    safeOn('#new-pr','click', ()=> {
      const title = prompt('Pull request title');
      if(!title) return;
      const pr = { id: uid('pr'), title, repoId: repo.id, author: App.user?App.user.displayName:'guest', created: now(), status:'open', description:'' };
      App.prs.push(pr);
      saveLS('archeo_prs', App.prs);
      loadRepoTab('prs', repo);
      toast('PR created');
    });
    out.querySelectorAll('.btn-delete-pr').forEach(b=> b.addEventListener('click', (e)=> deletePR(e.currentTarget.dataset.pr)));
  } else if(tab === 'timeline'){
    out.innerHTML = `<div><strong>Commit timeline</strong></div><div id="repo-timeline" style="margin-top:12px;"></div><div id="repo-commit-list" class="mt-3"></div>`;
    const years = repo.commits.map(c=>c.year);
    const minY = Math.min(...years), maxY = Math.max(...years);
    const container = document.getElementById('repo-timeline');
    if(!container) return;
    container.innerHTML = `<div id="repo-time-slider"></div>`;
    const sliderEl = document.getElementById('repo-time-slider');
    if (typeof noUiSlider !== 'undefined' && sliderEl) {
      if(!sliderEl._init){
        noUiSlider.create(sliderEl, {
          start: [minY, maxY],
          connect: true,
          range: { min: minY, max: maxY },
          step: 1,
          tooltips: [true, true],
          format: { to: v => Math.round(v), from: v => Number(v) }
        });
        sliderEl._init = true;
      } else {
        sliderEl.noUiSlider.updateOptions({ range: { min: minY, max: maxY }, start: [minY, maxY] });
        sliderEl.noUiSlider.set([minY, maxY]);
      }
      sliderEl.noUiSlider.on('update', (v)=>{
        const from = Number(v[0]), to = Number(v[1]);
        const list = repo.commits.filter(c=> c.year >= from && c.year <= to ).slice().reverse();
        const listEl = document.getElementById('repo-commit-list');
        if(listEl) listEl.innerHTML = list.map(c=>`<div style="padding:8px; border-bottom:1px solid #30363d;"><div style="font-weight:700">${escapeHTML(c.message)}</div><div class="muted small">${escapeHTML(c.year)} â€¢ ${escapeHTML(c.type)}</div><div class="mt-1"><button class="btn btn-sm btn-ghost btn-diff" data-commit="${c.id}">Diff</button><button class="btn btn-sm btn-ghost btn-3d" data-commit="${c.id}">3D</button></div></div>`).join('');
        document.querySelectorAll('#repo-commit-list .btn-diff').forEach(b=> b.addEventListener('click', (e)=> openDiffChooser(repo, e.currentTarget.dataset.commit)));
        document.querySelectorAll('#repo-commit-list .btn-3d').forEach(b=> b.addEventListener('click', (e)=> { const c = repo.commits.find(x=> x.id === e.currentTarget.dataset.commit); open3DViewer(repo, c); }));
      });
    } else {
      container.insertAdjacentHTML('beforeend', '<div class="muted small">Timeline requires noUiSlider (disabled).</div>');
      console.warn('noUiSlider not available â€” repo timeline disabled');
    }
  }
}

/* Issues board and PR list */
function renderIssuesBoard(root){
  const cols = ['todo','inprogress','done'];
  root.innerHTML = `
    <div class="Box p-3">
      <div class="d-flex justify-content-between">
        <div><h3 class="Box-title">Issues Board</h3></div>
        <div><button id="new-board-issue" class="btn btn-primary btn-sm">New issue</button></div>
      </div>
      <div class="d-flex mt-3" style="gap:12px;">
        ${cols.map(col=>`<div class="Box" style="flex:1; min-height:240px; padding:8px;"><div style="font-weight:700; margin-bottom:8px;">${col.toUpperCase()}</div><div id="col-${col}" style="min-height:160px;"></div></div>`).join('')}
      </div>
    </div>
  `;
  function refresh(){
    cols.forEach(col=>{
      const el = document.getElementById('col-'+col);
      if(!el) return;
      el.innerHTML = '';
      App.issues.filter(i=> i.status === col).forEach(i=>{
        const card = document.createElement('div');
        card.className = 'Box-row';
        card.style.marginBottom='8px';
        card.innerHTML = `<div style="flex:1"><div style="font-weight:700">${escapeHTML(i.title)}</div><div class="muted small">${escapeHTML(i.author)}</div></div>
          <div style="display:flex; flex-direction:column; gap:6px;"><div style="display:flex; gap:6px;"><button class="btn btn-sm btn-ghost btn-move" data-id="${i.id}" data-col="${col}">Move</button><button class="btn btn-sm btn-ghost btn-delete-issue" data-id="${i.id}">Delete</button></div></div>`;
        el.appendChild(card);
      });
    });
    document.querySelectorAll('.btn-move').forEach(b=> b.addEventListener('click', (e)=>{
      const id = e.currentTarget.dataset.id;
      const cur = e.currentTarget.dataset.col;
      const nextIndex = (cols.indexOf(cur) + 1) % cols.length;
      const issue = App.issues.find(i=> i.id === id);
      if(issue){ issue.status = cols[nextIndex]; saveLS('archeo_issues', App.issues); refresh(); }
    }));
    document.querySelectorAll('.btn-delete-issue').forEach(b=> b.addEventListener('click', (e)=> deleteIssue(e.currentTarget.dataset.id)));
  }
  safeOn('#new-board-issue','click', ()=>{
    const title = prompt('Issue title');
    if(!title) return;
    const repoId = prompt('Repository ID (optional)');
    const issue = { id: uid('iss'), title, repoId: repoId || App.repos[0].id, status:'todo', author: App.user?App.user.displayName:'guest', created: now(), comments: [] };
    App.issues.push(issue);
    saveLS('archeo_issues', App.issues);
    refresh();
    toast('Issue created');
  });
  refresh();
}

function renderPRList(root){
  const prs = App.prs;
  root.innerHTML = `
    <div class="Box p-3">
      <div class="d-flex justify-content-between">
        <h3 class="Box-title">Pull Requests</h3>
        <button id="new-pr-global" class="btn btn-primary btn-sm">New PR</button>
      </div>
      <div id="pr-list" class="mt-3"></div>
    </div>
  `;
  function refresh(){
    const el = document.getElementById('pr-list');
    if(!el) return;
    el.innerHTML = prs.map(p=>`<div class="Box-row"><div style="flex:1"><div style="font-weight:700">${escapeHTML(p.title)}</div><div class="muted small">${escapeHTML(p.author)} â€¢ ${escapeHTML(p.status)}</div></div><div style="display:flex; gap:8px;"><button class="btn btn-sm btn-ghost btn-merge" data-id="${p.id}">Merge</button><button class="btn btn-sm btn-ghost btn-delete-pr" data-id="${p.id}">Delete</button></div></div>`).join('');
    el.querySelectorAll('.btn-merge').forEach(b=> b.addEventListener('click', (e)=> mergePR(e.currentTarget.dataset.id)));
    el.querySelectorAll('.btn-delete-pr').forEach(b=> b.addEventListener('click', (e)=> deletePR(e.currentTarget.dataset.id)));
  }
  safeOn('#new-pr-global','click', ()=>{
    const title = prompt('PR title');
    const repoId = prompt('Repo ID for PR', App.repos[0].id);
    if(!title || !repoId) return;
    const pr = { id: uid('pr'), title, repoId, author: App.user?App.user.displayName:'guest', created: now(), status:'open', description: '' };
    App.prs.push(pr);
    saveLS('archeo_prs', App.prs);
    refresh();
    toast('PR created');
  });
  refresh();
}

/* PR merge */
function mergePR(prId){
  const pr = App.prs.find(p=> p.id === prId);
  if(!pr) return;
  if(!confirm(`Merge PR "${pr.title}"?`)) return;
  const repo = App.repos.find(r => r.id === pr.repoId);
  if(repo){
    const commit = { id: uid('merge'), author: pr.author, year: new Date().getFullYear(), type: 'Maintenance', message: `Merge PR: ${pr.title}`, layers: repo.commits[repo.commits.length-1].layers || [] };
    repo.commits.push(commit);
    saveLS('archeo_repos', App.repos);
  }
  pr.status = 'merged';
  saveLS('archeo_prs', App.prs);
  toast('PR merged');
  render();
}

/* Diff viewer and 3D viewer (guarded) */
function openDiffChooser(repo, commitId){
  const html = `<div class="card-dark" style="width:600px; max-width:95%; padding:12px;">
    <h4>Select base & compare commits</h4>
    <div style="display:flex; gap:8px; margin-top:8px;">
      <select id="diff-base" class="form-select form-select-sm" style="flex:1">${repo.commits.map(c=>`<option value="${c.id}">${c.year} â€” ${c.type} â€” ${c.message}</option>`).join('')}</select>
      <select id="diff-other" class="form-select form-select-sm" style="flex:1">${repo.commits.map(c=>`<option value="${c.id}">${c.year} â€” ${c.type} â€” ${c.message}</option>`).join('')}</select>
    </div>
    <div style="margin-top:12px; text-align:right;"><button id="do-diff" class="btn btn-primary btn-sm">Compare</button></div>
  </div>`;
  const overlay = document.createElement('div');
  overlay.className = 'overlay';
  overlay.innerHTML = html;
  document.body.appendChild(overlay);
  overlay.addEventListener('click', (e)=> { if(e.target === overlay) overlay.remove(); });
  overlay.querySelector('#do-diff').addEventListener('click', ()=>{
    const a = overlay.querySelector('#diff-base').value;
    const b = overlay.querySelector('#diff-other').value;
    overlay.remove();
    const base = repo.commits.find(c=> c.id === a);
    const other = repo.commits.find(c=> c.id === b);
    showDiffResults(repo, base, other);
  });
}

function showDiffResults(repo, base, other){
  const modal = document.createElement('div');
  modal.className = 'overlay';
  const added = other.layers.filter(l=> !base.layers.some(bl=> bl.name === l.name));
  const removed = base.layers.filter(l=> !other.layers.some(ol=> ol.name === l.name));
  modal.innerHTML = `
    <div class="card-dark" style="width:900px; max-width:95%; padding:12px;">
      <div class="d-flex justify-content-between align-items-center">
        <h3>Diff: ${escapeHTML(base.message)} â‡¢ ${escapeHTML(other.message)}</h3>
        <button class="btn btn-ghost btn-sm" id="close-diff">Close</button>
      </div>
      <div style="display:flex; gap:12px; margin-top:12px;">
        <div style="flex:1"><h4>Base</h4>${base.layers.map(l=>`<div style="padding:8px; ${removed.find(r=>r.name===l.name)?'background:rgba(255,80,80,0.06);':''}"><strong>${escapeHTML(l.name)}</strong> â€” ${l.thickness}cm</div>`).join('')}</div>
        <div style="flex:1"><h4>Other</h4>${other.layers.map(l=>`<div style="padding:8px; ${added.find(a=>a.name===l.name)?'background:rgba(52,199,89,0.06);':''}"><strong>${escapeHTML(l.name)}</strong> â€” ${l.thickness}cm</div>`).join('')}</div>
      </div>
      <div style="text-align:right; margin-top:12px;"><button id="open-other-3d" class="btn btn-primary btn-sm">Open Other in 3D</button></div>
    </div>
  `;
  document.body.appendChild(modal);
  modal.querySelector('#close-diff').addEventListener('click', ()=> modal.remove());
  modal.querySelector('#open-other-3d').addEventListener('click', ()=> { modal.remove(); open3DViewer(repo, other); });
}

function open3DViewer(repo, commit){
  if(!commit){
    alert('No commit selected');
    return;
  }
  if(typeof THREE === 'undefined'){
    alert('3D viewer requires Three.js (not loaded)');
    console.warn('Three.js not available');
    return;
  }
  const overlay = document.createElement('div');
  overlay.className = 'overlay';
  overlay.style.alignItems = 'stretch';
  overlay.innerHTML = `<div id="three-modal" style="flex:1; display:flex; flex-direction:column; max-width:1200px; margin:30px auto; border-radius:10px; overflow:hidden;"></div>`;
  document.body.appendChild(overlay);
  const container = document.getElementById('three-modal');
  container.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center; padding:12px; background:#161b22; color:#c9d1d9;"><div><strong>${escapeHTML(repo.name)}</strong> â€” ${escapeHTML(commit.message)}</div><div><button id="three-close" class="btn btn-ghost btn-sm">Close</button></div></div><div id="three-canvas" style="flex:1; background:#05060a;"></div>`;
  overlay.querySelector('#three-close').addEventListener('click', ()=> overlay.remove());
  const mount = document.getElementById('three-canvas');
  const w = Math.max(640, mount.clientWidth), h = Math.max(320, mount.clientHeight);
  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0x05060a);
  const camera = new THREE.PerspectiveCamera(45, w/h, 0.1, 2000);
  camera.position.set(0, 120, 320);
  const renderer = new THREE.WebGLRenderer({ antialias:true });
  renderer.setSize(w, h);
  mount.appendChild(renderer.domElement);
  const hemi = new THREE.HemisphereLight(0xffffff, 0x222222, 0.9); scene.add(hemi);
  const dir = new THREE.DirectionalLight(0xffffff, 0.6); dir.position.set(100,200,100); scene.add(dir);

  const layers = commit.layers || [];
  const total = layers.reduce((s,l)=> s + (l.thickness||10), 0);
  let y = -total/2;
  const group = new THREE.Group();
  layers.forEach(L => {
    const h = L.thickness || 10;
    const geom = new THREE.BoxGeometry(240, h, 160);
    const mat = new THREE.MeshStandardMaterial({ color: L.color || '#7fa7d9', roughness:0.6, metalness:0.1 });
    const mesh = new THREE.Mesh(geom, mat);
    mesh.position.y = y + h/2;
    mesh.userData = L;
    group.add(mesh);
    y += h;
  });
  scene.add(group);
  let dragging=false, lx=0, ly=0;
  mount.addEventListener('pointerdown', (e)=> { dragging=true; lx=e.clientX; ly=e.clientY; mount.style.cursor='grabbing'; });
  window.addEventListener('pointerup', ()=> { dragging=false; mount.style.cursor='default'; });
  mount.addEventListener('pointermove', (e)=> {
    if(!dragging) return;
    const dx = e.clientX - lx, dy = e.clientY - ly;
    lx = e.clientX; ly = e.clientY;
    group.rotation.y += dx*0.01;
    group.rotation.x += dy*0.01;
  });
  mount.addEventListener('wheel', (e)=> { camera.position.z += e.deltaY*0.1; camera.position.z = Math.max(80, Math.min(1200, camera.position.z)); });
  function animate(){ renderer.render(scene, camera); requestAnimationFrame(animate); }
  animate();
}

/* ----------------------------------------------------------------------------
   Profile page (enhanced)
   ---------------------------------------------------------------------------- */
function renderProfile(root){
  const user = App.user;
  if(!user){
    const auth = document.getElementById('auth-modal');
    if(auth) auth.hidden = false;
    return;
  }

  // Helper: get commits authored by this user across all repos
  const commitsByUser = [];
  App.repos.forEach(repo => {
    (repo.commits || []).forEach(c => {
      if(c.author === user.displayName || c.author === user.email) {
        commitsByUser.push({ repo, commit: c });
      }
    });
  });
  commitsByUser.sort((a,b) => (b.commit.year || 0) - (a.commit.year || 0));

  // Issues authored by user
  const issuesByUser = App.issues.filter(i => i.author === user.displayName || i.author === user.email).slice().reverse();

  // PRs authored by user
  const prsByUser = App.prs.filter(p => p.author === user.displayName || p.author === user.email).slice().reverse();

  // Repos owned (created by) user
  const reposOwned = App.repos.filter(r => r.owner === user.displayName);

  root.innerHTML = `
    <div class="Box p-3">
      <div style="display:flex; align-items:center; gap:12px;">
        <img src="${document.getElementById('avatar-img').src}" width="80" height="80" style="border-radius:12px;" />
        <div style="flex:1">
          <div style="font-weight:800; font-size:1.15rem;">${escapeHTML(user.displayName)}</div>
          <div class="muted small">${escapeHTML(user.email)}</div>
          <div style="margin-top:8px;" class="small muted">Member since (local demo)</div>
        </div>
        <div style="text-align:right;">
          <div style="font-weight:700">${reposOwned.length}</div>
          <div class="muted small">Repos added</div>
        </div>
      </div>
    </div>

    <div class="two-col" style="margin-top:16px;">
      <div>
        <div class="Box p-3 mb-3">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div><strong>Contributions</strong><div class="muted small">Recent activity across the community</div></div>
            <div class="muted small">Total commits: ${commitsByUser.length}</div>
          </div>
          <div style="margin-top:12px;">
            <div style="font-weight:700; margin-bottom:8px;">Recent commits by you</div>
            <div class="contrib-list">
              ${commitsByUser.slice(0,8).map(item => `<a href="#" data-route="repo" data-repo="${item.repo.id}" class="Box-row" style="text-decoration:none; color:inherit;"><div><div style="font-weight:700">${escapeHTML(item.commit.message)}</div><div class="muted small">${escapeHTML(item.repo.name)} â€¢ ${escapeHTML(item.commit.year)}</div></div></a>`).join('') || '<div class="muted small">No commits yet</div>'}
            </div>
          </div>
        </div>

        <div class="Box p-3 mb-3">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div><strong>Issues you opened</strong></div>
            <div class="muted small">${issuesByUser.length}</div>
          </div>
          <div style="margin-top:12px;">
            <div class="contrib-list">
              ${issuesByUser.slice(0,8).map(i => `<div class="Box-row"><div><div style="font-weight:700">${escapeHTML(i.title)}</div><div class="muted small">${escapeHTML(i.repoId ? (App.repos.find(r=> r.id === i.repoId) || {name: 'unknown'}).name : 'unknown')}</div></div><div><button class="btn btn-sm btn-ghost btn-delete-issue" data-id="${i.id}">Delete</button></div></div>`).join('') || '<div class="muted small">No issues opened</div>'}
            </div>
          </div>
        </div>

        <div class="Box p-3">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div><strong>Pull requests you opened</strong></div>
            <div class="muted small">${prsByUser.length}</div>
          </div>
          <div style="margin-top:12px;">
            <div class="contrib-list">
              ${prsByUser.slice(0,8).map(p => `<div class="Box-row"><div><div style="font-weight:700">${escapeHTML(p.title)}</div><div class="muted small">${escapeHTML((App.repos.find(r=> r.id === p.repoId) || {name:'unknown'}).name)}</div></div><div><button class="btn btn-sm btn-ghost btn-delete-pr" data-pr="${p.id}">Delete</button></div></div>`).join('') || '<div class="muted small">No PRs opened</div>'}
            </div>
          </div>
        </div>
      </div>

      <aside class="panel-right">
        <div class="Box p-3 mb-3">
          <div style="font-weight:700">Your repositories</div>
          <div class="muted small mt-2">${reposOwned.length} repos added by you</div>
          <div class="mt-3">
            ${reposOwned.slice(0,6).map(r => `<div class="Box-row"><a href="#" data-route="repo" data-repo="${r.id}">${escapeHTML(r.name)}</a></div>`).join('') || '<div class="muted small">No repos yet</div>'}
          </div>
        </div>

        <div class="Box p-3">
          <div style="font-weight:700">Quick actions</div>
          <div class="mt-2 small muted">Create or manage your contributions</div>
          <div class="mt-2">
            <button id="profile-new-finding" class="btn btn-ghost btn-sm">Add finding</button>
            <button id="profile-open-issues" class="btn btn-ghost btn-sm">Open issues board</button>
          </div>
        </div>
      </aside>
    </div>
  `;

  // attach handlers inside profile
  document.querySelectorAll('[data-route="repo"]').forEach(a=>{
    a.addEventListener('click', (e)=> { e.preventDefault(); const id = e.currentTarget.getAttribute('data-repo'); navigate('repo', { repoId: id }); });
  });
  // delete buttons present in issues / prs blocks
  document.querySelectorAll('.btn-delete-issue').forEach(b=> b.addEventListener('click', (e)=> { deleteIssue(e.currentTarget.dataset.id); }));
  document.querySelectorAll('.btn-delete-pr').forEach(b=> b.addEventListener('click', (e)=> { deletePR(e.currentTarget.dataset.pr); }));

  safeOn('#profile-new-finding','click', ()=> {
    const m = document.getElementById('new-finding-modal'); if(m) m.hidden = false;
  });
  safeOn('#profile-open-issues','click', ()=> navigate('issues'));
}

/* ----------------------------------------------------------------------------
   Boot & initial wiring (unchanged)
   ---------------------------------------------------------------------------- */
function attachHeaderLinks(){
  document.querySelectorAll('[data-route]').forEach(a=>{
    a.addEventListener('click', (e)=>{
      e.preventDefault();
      const r = e.currentTarget.getAttribute('data-route');
      if(r === 'repo'){
        const repoId = e.currentTarget.getAttribute('data-repo');
        navigate('repo', { repoId });
      } else navigate(r);
    });
  });
}

safeOn('#open-explore','click', ()=> navigate('explore'));
const mapLink = document.querySelector('.Header-link[data-route="map"]');
if(mapLink) mapLink.addEventListener('click', (e)=> { e.preventDefault(); navigate('map'); });
const issuesLink = document.querySelector('.Header-link[data-route="issues"]');
if(issuesLink) issuesLink.addEventListener('click', (e)=> { e.preventDefault(); navigate('issues'); });
const prsLink = document.querySelector('.Header-link[data-route="prs"]');
if(prsLink) prsLink.addEventListener('click', (e)=> { e.preventDefault(); navigate('prs'); });
const exploreLink = document.querySelector('.Header-link[data-route="explore"]');
if(exploreLink) exploreLink.addEventListener('click', (e)=> { e.preventDefault(); navigate('explore'); });

updateHeaderAuth();

(function initRoute(){
  const h = window.location.hash.slice(1);
  if(!h) { App.page = 'explore'; }
  else {
    const parts = h.split('-');
    App.page = parts[0] || 'explore';
    App.currentRepoId = parts[1] || null;
  }
  render();
  attachHeaderLinks();
})();

</script>
</body>
</html>
